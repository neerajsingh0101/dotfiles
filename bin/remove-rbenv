#!/usr/bin/env bash
#
# Uninstall rbenv and verify it is completely removed.
#
# Usage: remove-rbenv
#
set -euo pipefail

echo "==> Removing rbenv..."
echo ""

errors=0

fail() {
  echo "FAIL: $*"
  errors=$((errors + 1))
}

warn() {
  echo "WARN: $*"
}

pass() {
  echo "PASS: $*"
}

# ── 1. Uninstall rbenv via Homebrew (if installed that way) ──────────────
if command -v brew >/dev/null 2>&1; then
  if brew list --formula rbenv >/dev/null 2>&1; then
    echo "Uninstalling rbenv via Homebrew..."
    brew uninstall rbenv
  else
    pass "rbenv is not installed via Homebrew."
  fi

  if brew list --formula ruby-build >/dev/null 2>&1; then
    echo "Uninstalling ruby-build via Homebrew..."
    brew uninstall ruby-build
  else
    pass "ruby-build is not installed via Homebrew."
  fi
else
  warn "Homebrew not found; skipping brew uninstall checks."
fi

# ── 2. Remove rbenv directories/files ───────────────────────────────────
if [ -d "$HOME/.rbenv" ]; then
  echo "Removing ~/.rbenv directory..."
  rm -rf "$HOME/.rbenv"
else
  pass "~/.rbenv directory not found (already removed)."
fi

# Some setups create this
if [ -f "$HOME/.rbenvrc" ]; then
  echo "Removing ~/.rbenvrc..."
  rm -f "$HOME/.rbenvrc"
else
  pass "~/.rbenvrc not found (already removed)."
fi

# ── 3. Find rbenv references in shell config files ───────────────────────
shell_files=(
  "$HOME/.zshrc"
  "$HOME/.zprofile"
  "$HOME/.zshenv"
  "$HOME/.zlogin"
  "$HOME/.bashrc"
  "$HOME/.bash_profile"
  "$HOME/.profile"
)

found_refs=false
for file in "${shell_files[@]}"; do
  if [ -f "$file" ] && grep -q "rbenv" "$file" 2>/dev/null; then
    found_refs=true
    echo ""
    warn "Found rbenv references in $file:"
    grep -n "rbenv" "$file" || true
    echo ""
    echo "Please remove these lines manually."
  fi
done

# ── 4. Verification checks ───────────────────────────────────────────────
echo ""
echo "==> Running verification checks..."
echo ""

# Check: rbenv command should not be found
if command -v rbenv >/dev/null 2>&1; then
  fail "'rbenv' command is still available at $(command -v rbenv)"
else
  pass "'rbenv' command is not found."
fi

# Check: ~/.rbenv directory should not exist
if [ -d "$HOME/.rbenv" ]; then
  fail "~/.rbenv directory still exists."
else
  pass "~/.rbenv directory does not exist."
fi

# Check: rbenv shims/bin should not be in PATH
rbenv_path_hits="$(echo "$PATH" | tr ':' '\n' | grep -E '/\.rbenv/(shims|bin)($|/)' || true)"
if [ -n "$rbenv_path_hits" ]; then
  fail "rbenv entries are still in PATH:
$rbenv_path_hits
(Open a new shell for PATH changes to take effect.)"
else
  pass "No rbenv entries in PATH."
fi

# Check: Homebrew should not have rbenv installed
if command -v brew >/dev/null 2>&1; then
  if brew list --formula rbenv >/dev/null 2>&1; then
    fail "rbenv is still installed via Homebrew."
  else
    pass "rbenv is not installed via Homebrew."
  fi
fi

# Check: no rbenv references remain in shell config files
if [ "$found_refs" = false ]; then
  pass "No rbenv references found in common shell config files."
else
  fail "rbenv references remain in shell config files (see warnings above)."
fi

# ── Summary ──────────────────────────────────────────────────────────────
echo ""
if [ "$errors" -eq 0 ]; then
  echo "rbenv has been completely removed."
  echo "Open a new terminal session to ensure all changes take effect."
else
  echo "$errors check(s) failed. Please review the output above."
  exit 1
fi

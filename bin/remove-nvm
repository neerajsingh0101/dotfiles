#!/usr/bin/env bash
#
# Uninstall nvm and verify it is completely removed.
#
# Usage: remove-nvm
#
set -euo pipefail

echo "==> Removing nvm..."
echo ""

errors=0

fail() {
  echo "FAIL: $*"
  errors=$((errors + 1))
}

warn() {
  echo "WARN: $*"
}

pass() {
  echo "PASS: $*"
}

# ── 1. Uninstall nvm via Homebrew (if installed that way) ───────────────
if command -v brew >/dev/null 2>&1; then
  if brew list --formula nvm >/dev/null 2>&1; then
    echo "Uninstalling nvm via Homebrew..."
    brew uninstall nvm
  else
    pass "nvm is not installed via Homebrew."
  fi
else
  warn "Homebrew not found; skipping brew uninstall checks."
fi

# ── 2. Remove the ~/.nvm directory ──────────────────────────────────────
if [ -d "$HOME/.nvm" ]; then
  echo "Removing ~/.nvm directory..."
  rm -rf "$HOME/.nvm"
else
  pass "~/.nvm directory not found (already removed)."
fi

# ── 3. Find nvm references in shell config files ────────────────────────
shell_files=(
  "$HOME/.zshrc"
  "$HOME/.zprofile"
  "$HOME/.zshenv"
  "$HOME/.zlogin"
  "$HOME/.bashrc"
  "$HOME/.bash_profile"
  "$HOME/.profile"
)

found_refs=false
for file in "${shell_files[@]}"; do
  if [ -f "$file" ] && grep -E -q "(^|[^[:alnum:]_])(nvm|NVM_DIR)([^[:alnum:]_]|$)" "$file" 2>/dev/null; then
    found_refs=true
    echo ""
    warn "Found nvm references in $file:"
    grep -n -E "(^|[^[:alnum:]_])(nvm|NVM_DIR)([^[:alnum:]_]|$)" "$file" || true
    echo ""
    echo "Please remove these lines manually."
  fi
done

# ── 4. Verification checks ──────────────────────────────────────────────
echo ""
echo "==> Running verification checks..."
echo ""

# Check: nvm command/function should not be found
# (nvm is often a shell function, not a binary)
if command -v nvm >/dev/null 2>&1; then
  fail "'nvm' is still available at: $(command -v nvm)"
else
  pass "'nvm' is not found."
fi

# Check: ~/.nvm directory should not exist
if [ -d "$HOME/.nvm" ]; then
  fail "~/.nvm directory still exists."
else
  pass "~/.nvm directory does not exist."
fi

# Check: NVM_DIR should not be set
if [ -n "${NVM_DIR:-}" ]; then
  fail "NVM_DIR is still set to '$NVM_DIR'.
(Open a new shell for environment changes to take effect.)"
else
  pass "NVM_DIR is not set."
fi

# Check: nvm entries should not be in PATH
nvm_path_hits="$(echo "$PATH" | tr ':' '\n' | grep -E '/\.nvm($|/)' || true)"
if [ -n "$nvm_path_hits" ]; then
  fail "nvm entries are still in PATH:
$nvm_path_hits
(Open a new shell for PATH changes to take effect.)"
else
  pass "No nvm entries in PATH."
fi

# Check: Homebrew should not have nvm installed
if command -v brew >/dev/null 2>&1; then
  if brew list --formula nvm >/dev/null 2>&1; then
    fail "nvm is still installed via Homebrew."
  else
    pass "nvm is not installed via Homebrew."
  fi
fi

# Check: no nvm references remain in shell config files
if [ "$found_refs" = false ]; then
  pass "No nvm references found in common shell config files."
else
  fail "nvm references remain in shell config files (see warnings above)."
fi

# ── Summary ──────────────────────────────────────────────────────────────
echo ""
if [ "$errors" -eq 0 ]; then
  echo "nvm has been completely removed."
  echo "Open a new terminal session to ensure all changes take effect."
else
  echo "$errors check(s) failed. Please review the output above."
  exit 1
fi
